// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  output   = "../app/generated/prisma"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DATABASE_URL")
}

// ==================== USER & AUTH ====================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String?
  password      String?
  emailVerified DateTime?
  image         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  accounts Account[]
  sessions Session[]
  orders   Order[]

  @@map("user")
}

model Account {
  id                     String    @id @default(cuid())
  userId                 String
  accountId              String
  providerId             String
  accessToken            String?
  refreshToken           String?
  idToken                String?
  accessTokenExpiresAt   DateTime?
  refreshTokenExpiresAt  DateTime?
  scope                  String?
  password               String?
  createdAt              DateTime  @default(now())
  updatedAt              DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([providerId, accountId])
  @@index([userId])
  @@map("account")
}

model Session {
  id        String   @id @default(cuid())
  expiresAt DateTime
  token     String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  ipAddress String?
  userAgent String?
  userId    String

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("session")
}

model Verification {
  id         String   @id @default(cuid())
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([identifier])
  @@map("verification")
}

// ==================== BRAND ====================

model Brand {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  logo        String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  products Product[]

  @@map("brand")
}

// ==================== CATEGORY ====================

model Category {
  id          String   @id @default(cuid())
  name        String   @unique // Baju, Celana, Sepatu, Topi
  description String?
  slug        String   @unique
  image       String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  products Product[]

  @@map("category")
}

// ==================== PRODUCT ====================

model Product {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique
  description String?
  basePrice   Decimal  @db.Decimal(10, 2)
  categoryId  String
  brandId     String
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  category Category @relation(fields: [categoryId], references: [id], onDelete: Restrict)
  brand    Brand    @relation(fields: [brandId], references: [id], onDelete: Restrict)

  images        ProductImage[]
  variants      ProductVariant[]
  reviews       Review[]
  orderItems    OrderItem[]

  @@index([categoryId])
  @@index([brandId])
  @@index([slug])
  @@map("product")
}

model ProductImage {
  id        String   @id @default(cuid())
  productId String
  url       String
  altText   String?
  isPrimary Boolean  @default(false)
  order     Int      @default(0)
  createdAt DateTime @default(now())

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@map("product_image")
}

// ==================== VARIANT & STOCK ====================

model ProductVariant {
  id        String   @id @default(cuid())
  productId String
  size      String?  // S, M, L, XL, XXL atau 38, 39, 40 (untuk sepatu)
  color     String?  // Hitam, Putih, Merah, dll
  sku       String   @unique // Stock Keeping Unit
  price     Decimal  @db.Decimal(10, 2) // Harga bisa berbeda per variant
  stock     Int      @default(0) // Jumlah stok
  weight    Int?     // Berat dalam gram (untuk ongkir)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  stockHistories StockHistory[]
  orderItems     OrderItem[]

  @@index([productId])
  @@index([sku])
  @@map("product_variant")
}

// ==================== STOCK HISTORY ====================

model StockHistory {
  id        String   @id @default(cuid())
  variantId String
  type      StockMovementType // IN, OUT, ADJUSTMENT
  quantity  Int      // Positif untuk masuk, negatif untuk keluar
  notes     String?
  reference String?  // Order ID, Purchase Order, dll
  createdBy String?
  createdAt DateTime @default(now())

  variant ProductVariant @relation(fields: [variantId], references: [id], onDelete: Cascade)

  @@index([variantId])
  @@index([createdAt])
  @@map("stock_history")
}

enum StockMovementType {
  IN          // Stok masuk (pembelian, retur)
  OUT         // Stok keluar (penjualan)
  ADJUSTMENT  // Penyesuaian stok
}

// ==================== ORDER ====================

model Order {
  id              String      @id @default(cuid())
  orderNumber     String      @unique
  userId          String
  status          OrderStatus @default(PENDING)
  totalAmount     Decimal     @db.Decimal(10, 2)
  shippingCost    Decimal     @db.Decimal(10, 2) @default(0)
  discount        Decimal     @db.Decimal(10, 2) @default(0)
  grandTotal      Decimal     @db.Decimal(10, 2)
  paymentMethod   String?
  paymentStatus   PaymentStatus @default(UNPAID)
  shippingAddress String
  notes           String?
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  user       User        @relation(fields: [userId], references: [id], onDelete: Restrict)
  orderItems OrderItem[]

  @@index([userId])
  @@index([orderNumber])
  @@index([status])
  @@map("order")
}

model OrderItem {
  id        String   @id @default(cuid())
  orderId   String
  productId String
  variantId String
  quantity  Int
  price     Decimal  @db.Decimal(10, 2)
  subtotal  Decimal  @db.Decimal(10, 2)
  createdAt DateTime @default(now())

  order   Order          @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product Product        @relation(fields: [productId], references: [id], onDelete: Restrict)
  variant ProductVariant @relation(fields: [variantId], references: [id], onDelete: Restrict)

  @@index([orderId])
  @@index([productId])
  @@index([variantId])
  @@map("order_item")
}

enum OrderStatus {
  PENDING     // Menunggu pembayaran
  PAID        // Sudah dibayar
  PROCESSING  // Sedang diproses
  SHIPPED     // Sudah dikirim
  DELIVERED   // Sudah diterima
  CANCELLED   // Dibatalkan
  RETURNED    // Diretur
}

enum PaymentStatus {
  UNPAID
  PAID
  FAILED
  REFUNDED
}

// ==================== REVIEW ====================

model Review {
  id        String   @id @default(cuid())
  productId String
  userId    String
  rating    Int      // 1-5
  comment   String?
  images    String[] // Array URL gambar review
  isVerified Boolean @default(false) // Review dari pembeli terverifikasi
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@index([userId])
  @@map("review")
}

// ==================== CUSTOM STATUS & DETAIL ====================

model Status {
  idStatus    String   @id @default(cuid())
  statusName  String
  description String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("status")
}

model Detail {
  idDetail   String   @id @default(cuid())
  detailName String
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@map("detail")
}